---
title: 'OHI 2017: Commercial Fishing Pressure Layers '
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: show
    toc: true
    toc_depth: 1
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '../../../src/templates/ohi_hdr.html'
pdf_document:
  toc: true
---

# Summary

The commercial fishing pressure layers are created from spatialized catch by gear data provided by Watson (2018), and net primary production data from the Vertically Generalized Production Model [(VGPM)](http://www.science.oregonstate.edu/ocean.productivity/) as described in [Behrenfeld and Falkowski (1997)](http://www.science.oregonstate.edu/ocean.productivity/references/L&O%201997a.pdf).

This script prepares and formats the IMAS Global Fisheries Catch raw data into intermediate data by combining CatchInd_XXXX_XXXX and CatchNInd_XXXX_XXXX rds files with Index.csv and Cells.csv as well as a single file with all years.

We create raster files of total annual global catch from the Watson data and correct for system productivity by dividing catch by NPP: [quick review](https://www.researchgate.net/publication/312614653_Reconciling_fisheries_catch_and_ocean_productivity).

# Updates from previous assessment

* No longer using gear type to classify catch data as high or low bycatch, since the IMAS data now provides values for **discards**, which we consider as bycatch. 
* Previously, the raw catch data was all in a single file. This year, we have to combine across three different data tables: catch data (CatchInd_XXXX_XXXX), master index file with country name, species, etc (Index.csv), and geospatial information (Cells.csv).
* Previously raw catch data was in tonnes/km^2^, but this year they are in tonnes. The area in km^2^ values are located in the Cells.csv file
* One other change from last year is that we will gapfill the missing NPP data prior to using

# Data Source

**Reference**: Watson, R. A. and Tidd, A. 2018. Mapping nearly a century and a half of global marine fishing: 1869â€“2015. Marine Policy, 93, pp. 171-177. [(Paper URL)](https://doi.org/10.1016/j.marpol.2018.04.023)

**Downloaded**: July 17, 2018 from [IMAS portal](http://data.imas.utas.edu.au/portal/search?uuid=ff1274e1-c0ab-411b-a8a2-5a12eb27f2c0) - clikc on download tab, step 3

**Description**:  Global fisheries landings data per cell separated by Industrial versus Non-Industrial catch, IUU, and discards.

**Native data resolution**:   

**Time range**: 1950 - 2015

**Format**:  CSV format

**Additional Information**: [Metadata](http://metadata.imas.utas.edu.au/geonetwork/srv/eng/metadata.show?uuid=ff1274e1-c0ab-411b-a8a2-5a12eb27f2c0), [Supplementary Material](https://ars.els-cdn.com/content/image/1-s2.0-S0308597X18300605-mmc1.docx)


***
  
# Setup

```{r setup, echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}

library(tidyverse)
library(purrr)
library(here) # install.packages("here")
setwd(here::here("globalprep","prs_fish","v2018"))

source("https://rawgit.com/OHI-Science/ohiprep_v2018/master/src/R/common.R")

rawFolder <- file.path(dir_M, "git-annex/globalprep/_raw_data/IMAS_GlobalFisheriesLandings/d2018")
rastFolder <- paste0(dir_M,"/git-annex/globalprep/prs_fish/v2018/int/")

```

# New Global Fisheries Raw Data

Download the following from the **data_download.Rmd** script:

* Industrial Catch (1950 - 1954) - reported, iuu, and discard catch data for each cell location and unique identifier
* Master Index File (Index.csv) - information associated with the unique identifiers in the Industrial Catch data
* Spatial Cells Reference (Cell.csv) - contains geospatial information associated wtih the Industrial Catch data

# Explore Data

Read in Master Index file, Spatial cells, and a single 5-year Catch dataset. 

Filter master file to only include `ID`, `Year`, `CountryName`, `TaxonName`, `CommonName`, `FleetGearName` (I actually don't think we will need the `CountryName` or `FleetGearName`, but it might be interesting).

```{r}

## Master index file
master <- read.csv(file.path(rawFolder,"Index.csv")) %>% 
  select(ID, Year, CountryName, TaxonName, CommonName, FleetGearName)
DT::datatable(head(master))

## Spatial cells reference
spatialCells <- read.csv(file.path(rawFolder,"Cells.csv"))
DT::datatable(head(spatialCells))

```

```{r}

## Look at single catch file
data <- readRDS(file.path(rawFolder,"CatchInd_1950_1954.rds"))
DT::datatable(head(data))

```

Test to see whether the values for **IndReported**, **IndIUU**, and **IndDiscards** in the Master Index File are sum totals of Clams cockles arkshells in the Republic of Korea in year 1953.
```{r, eval=FALSE}

korea_clam <- data %>% 
  filter(ID == 491423) %>% 
  mutate(tot_Reported = sum(Reported),
         tot_IUU = sum(IUU),
         tot_Discards = sum(Discards))

master_check <- master %>%
  filter(ID == 491423)

## IndReported, IndIUU, IndDiscards should match tot_Reported, tot_IUU, and tot_Discards
DT::datatable(head(korea_clam))
head(master_check)

```

# Methods

## Wrangle 

### Tidy Fisheries Files

1. Combine the Master Index and Spatial Cells with the CatchInd and CatchNInd files.
2. Save each year of data as a separate file into: "globalprep/prs_fish/v2018/int/annual_catch"

**Function for Combining & Saving Files**: Create function to read in each file name, combine with Index and Cells data frame, and save each year of catch data into a separate file in mazu.

```{r tidy, eval=FALSE}

## Set function to read in each file, combine with Index.csv and Cells.csv, and save each year of data back into mazu
combine_fis <- function(x) {

  ## Read in the catch data
  ## Create a total Landings column
  ## Join with master and spatial cells file
  df <- readRDS(x) %>%
    mutate(Landings = Reported+IUU) %>% 
    left_join(master, by = "ID") %>% 
    left_join(spatialCells, by = "Cell")
  
  
  ## Save each individual year as a single file
  five_years <- sort(unique(df$Year)) 
  
  for(yr in five_years){
    print(yr) # will show you your progress
    
    single_yr_df <- df %>%
      filter(Year == yr)
    
    ## Save files with prefix CatchInd or CatchNInd
    ## Remove the suffix starting with '_' to get CatchInd or CatchNInd
    ind_Nind <- basename(x) %>% 
      tools::file_path_sans_ext() %>% 
      str_remove("_.*") # remove everything after the first underscore
    
    write_rds(single_yr_df, paste0(dir_M,"/git-annex/globalprep/prs_fish/v2018/int/annual_catch/", ind_Nind, "_", yr, ".rds"))
    
  }
  
  }

```

**Industrial Catch Data**

Create list of industrial catch file names and apply the `combine_fis` function to save each individual 5-year interval catch data.

```{r, eval=FALSE}

ind_files <- dir(file.path(dir_M,"git-annex/globalprep/prs_fish/v2018/int/annual_catch"), pattern ="CatchInd", full.names=TRUE)

## Wrangle and Save Each Year of Data Separately
indCatch <- map_df(ind_files, combine_fis)

```

**Non-industrial Catch Data**

Create list of non-industrial catch file names and apply the `combine_fis` function to save each individual 5-year interval catch data. Then, create a single file that has all years of data.

```{r, eval=FALSE}

nind_files <- dir(file.path(dir_M,"git-annex/globalprep/prs_fish/v2018/int/annual_catch"), pattern ="CatchNInd", full.names=TRUE)

## Wrangle and Save Each Year of Data Separately
nindCatch <- map_df(nind_files, combine_fis)

```


### Create Annual Catch Rasters

We want a landings raster and a discards raster for Industrial (commericial) and Non-Industrial (artisanal) data per year. 

Note: Annual catch per cell contains values in units of kg per km^2^. Since values in `Reported`, `Discards`, `Landings`, and `IUU` are in tonnes, they must be first converted to kg then divided by the `Area` column.

1. Setup 
```{r annRasters, eval=FALSE}

library(tidyverse)
library(parallel)
library(foreach)
library(doParallel)
library(raster)
library(rasterVis)
library(seaaroundus)
library(RColorBrewer)
library(cowplot)
library(stringr)

registerDoParallel(5) # registering cores for parallel processing

ocean <- raster::raster(file.path(dir_M, 'model/GL-NCEAS-Halpern2008/tmp/ocean.tif'))
rastFolder <- paste0(dir_M,"/git-annex/globalprep/prs_fish/v2018/int/")
options(scipen=999)

## color palette
cols = rev(colorRampPalette(brewer.pal(11, 'Spectral'))(255)) # rainbow color scheme
mytheme=rasterTheme(region=cols)

## set mollweide projection CRS
mollCRS=crs('+proj=moll +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +units=m +no_defs')

```

2. First get the template raster with a resolution of 0.5 degree cells. The getcells() function comes from the seaaroundus R package.

The values of these cells are the Cell ID numbers. In the fisheries catch dataset, these Cell ID numbers match up with the "Seq" numbers.

```{r, eval=FALSE}

saup_cells <- getcells("POLYGON ((-180 90, 180 90, 180 -90, -180 -90, -180 90))")

saup_rast <- raster(ncol=720, nrow=360)
saup_rast[] <- saup_cells
   
plot(saup_rast,col=cols,main = "SAUP Cell IDs")

```

3. Create commercial and artisanal rasters

* comm_landings_XXXX.tif
* comm_discards_XXXX.tif
* artisanal_landings_XXXX.tif
* artisanal_discards_XXXX.tif

Catch data is in tonnes, so need to convert to kg then divide by `Area` (km^2^) to get catch per area. Since `Cell` is the identifier for a specific 30-min spatial cell, we want to add up total landings and total discards grouped by `Cell`.

Note: Subset for data 2003 and onwards since NPP data starts at 2003. Since we will be taking 5-year averages, we will need years 1999-2003 to get the average value for year 2003.

```{r, eval=FALSE}

## Specify years of data, file locations, raster output location
years = c(1999:2015)
annual_files <- list.files(file.path(rawFolder, "int"), full.names=TRUE)


## Specify a list of arguments - commercial or artisanal - for reading in data and saving raster file name
raw_suffx <- list(catchind = "CatchInd", catchnind = "CatchNInd")
rast_prefx <- list(comm = "comm", artisanal = "artisanal")

## Function for totalling landings/discards and saves raster files 
catch2raster <- function(raw_suffx,rast_prefx){
  
foreach(yr = years) %dopar% { #yr = 2003
  
  ## find file path of the respective year of data
  yr <- as.character(yr)
  ## Select the respective year of industrial catch data
  dataname <- str_subset(annual_files, paste0(raw_suffx,"*.",yr))
  ## read in raw data
  raw_data <- readRDS(dataname)
 
  ## Total Landings per Cell
  landings <- raw_data %>%
    dplyr::mutate(Landings_CR = (Landings * 1000)/Area) %>% # convert to catch rate (kg/km^2)
    dplyr::group_by(Cell) %>%
    dplyr::summarise(cell_catch = sum(Landings_CR, na.rm=TRUE)) %>% # usually no NAs, but just in case
    dplyr::ungroup()

  ## Total Discards per Cell
  discards <- raw_data %>%
    dplyr::mutate(Discards_CR = (Discards * 1000)/Area) %>% 
    dplyr::group_by(Cell) %>%
    dplyr::summarise(cell_catch = sum(Discards_CR)) %>% 
    dplyr::ungroup()
  
  ## Rasterize Catch: swapping template cell values with those in dataframe
  raster::subs(saup_rast, landings, by = "Cell", which = "cell_catch", subsWithNA=TRUE, 
               filename = paste0(rastFolder, rast_prefx, '_landings/annual_catch_', yr ,'.tif'), overwrite=TRUE)
  raster::subs(saup_rast, discards, by = "Cell", which = "cell_catch", subsWithNA=TRUE, 
               filename = paste0(rastFolder, rast_prefx, '_discards/annual_catch_', yr ,'.tif'), overwrite=TRUE) 
  
  }
}

## Applies catch2raster function on commercial (industrial) then artisanal (non-industrial) files
create_rast <- map2(raw_suffx, rast_prefx, catch2raster)

```

### Check Rasters

Compare composite of newly created rasters with industrial landings figure created in [Watson (2018)](https://www.sciencedirect.com/science/article/pii/S0308597X18300605). See [Figure 2D](https://ars.els-cdn.com/content/image/1-s2.0-S0308597X18300605-gr2_lrg.jpg), which maps industrial landings in tonnes between 2000 and 2015.

```{r, eval=FALSE}

library(colorspace)
library(sp)
library(RColorBrewer)
cols = rev(colorRampPalette(brewer.pal(11, 'Spectral'))(255)) # rainbow color scheme

## Read in rasters for commercial landings between 2000 and 2015
commercial <- list.files(paste0(rastFolder,"comm_landings"),full.names = TRUE)

## Plot one year of data
catch <- raster(commercial[17])
plot(catch)
res(catch) # 0.5 degree cells

# ## Compare 2000-2015 industrial catch (log-transformed) to Watson figure
# ## create a raster stack from the input raster files (exclude 1999 which is commercial[1])
# allRasters <- raster::stack(commercial[2:17])
# 
# ## run the sum function on the raster stack - i.e. add (non-cumulatively) the rasters together
# tot_Catch <- sum(allRasters)
# 
# ## apply log to adjust for really large values
# log_Catch <- raster::calc(tot_Catch, function(x){log(x+1)},
#              filename = paste0(rastFolder,"datacheck/commLand_2000_2015_log.tif"), overwrite=TRUE)
# 
# ## Plot & Save raster
# png(filename="figs/log_IndCatch_2000_2015.png")
# plot(log_Catch, col=cols, alpha=1)
# dev.off()
# 
# ## Check out some values or zoom in on an area
# click(log_Catch)
# zoom(log_Catch)


```

### Standardize Fisheries Catch

Use **net primary production** (NPP) data to correct global fisheries catch for spatial differences in ecosystem impact

* Prepare and gapfill NPP data in [**npp.Rmd**](https://mazu.nceas.ucsb.edu/rstudio/files/github/ohiprep_v2018/globalprep/prs_fish/v2018/npp.html)
* Resample NPP and fish catch rasters to ocean raster
* Correct fish catch with NPP (catch divided by NPP)

Read in gapfilled NPP rasters
```{r gapfill}

npp_files_gf <- list.files(file.path(dir_M,"git-annex/globalprep/prs_fish/v2018/VGPM_primary_productivity/int/annual_npp"), full.names=TRUE, pattern = "gf")

plot(raster(npp[13]), col=cols, axes=FALSE, main = 'Net Primary Production (mg C/m2/day) \n 2015')

```

Create function standardizing catch by NPP

* read in a single year of catch data
* read in the same year of npp data
* transform npp raster to match the crs and res of the catch raster (coarser resolution will run faster)
* correct fisheries catch with npp raster
* save corrected fish catch rasters!!

```{r, eval=FALSE}


catch_npp_fun <- function(file, layer){ # file = dem_d_files[1]  layer = 'dem_dest'
  
  catch <- raster(file)
  
  yr <- substr(file, nchar(file)-7, nchar(file)-4) # extracts the year, may need to change numbers
  
  npp <- npp_files_gf[str_detect(npp_files_gf, yr)] %>% 
    raster()
  
  catch_resmp <- catch %>%
        projectRaster(npp, method = 'ngb', filename = file.path(dir_M,"git-annex/globalprep/prs_fish/v2018/tmp/temp_resample.tif"), overwrite=TRUE)
  
  catch_corr <- overlay(catch_resmp, npp, fun=function(x,y){x/y}, filename = file.path(dir_M, sprintf("git-annex/globalprep/prs_fish/v2018/int/%s/annual_catch_corr_%s.tif",layer,yr)), overwrite=TRUE)
  
}

```

```{r stdCatch}

## Specify years of catch data that match with years available in NPP data
years_of_data <- 2003:2015
years_filter <-  paste(years_of_data, collapse="|")

## Get file names in each of the four catch categories
comm_land <- list.files(paste0(rastFolder,"comm_landings"), pattern = "annual_catch", full.names = TRUE)
comm_land <- comm_land[grep(years_filter, comm_land)]

comm_disc <- list.files(paste0(rastFolder,"comm_discards"), pattern = "annual_catch", full.names = TRUE)
comm_disc <- comm_disc[grep(years_filter, comm_disc)]
  
art_land <- list.files(paste0(rastFolder,"artisanal_landings"), pattern = "annual_catch", full.names = TRUE)
art_land <- art_land[grep(years_filter, art_land)]

art_disc <- list.files(paste0(rastFolder,"artisanal_discards"), pattern = "annual_catch", full.names = TRUE)
art_disc <- art_disc[grep(years_filter, art_disc)]

lapply(comm_land, catch_npp_fun, layer = 'comm_landings')
lapply(comm_disc, catch_npp_fun, layer = 'comm_discards')
lapply(art_land, catch_npp_fun, layer = 'artisanal_landings')
lapply(art_disc, catch_npp_fun, layer = 'artisanal_discards')


```


# Gapfill

# Data Checks







