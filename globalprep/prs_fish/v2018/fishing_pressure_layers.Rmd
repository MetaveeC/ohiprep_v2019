---
title: 'OHI 2017: Commercial Fishing Pressure Layers '
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: show
    toc: true
    toc_depth: 1
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '../../../src/templates/ohi_hdr.html'
pdf_document:
  toc: true
---

# Summary

The commercial fishing pressure layers are created from spatialized catch by gear data provided by Watson (2018), and net primary production data from the Vertically Generalized Production Model [(VGPM)](http://www.science.oregonstate.edu/ocean.productivity/) as described in [Behrenfeld and Falkowski (1997)](http://www.science.oregonstate.edu/ocean.productivity/references/L&O%201997a.pdf).

This script prepares and formats the IMAS Global Fisheries Catch raw data into intermediate data by combining CatchInd_XXXX_XXXX and CatchNInd_XXXX_XXXX rds files with Index.csv and Cells.csv as well as a single file with all years.

We create raster files of total annual global catch from the Watson data and correct for system productivity by dividing catch by NPP: [quick review](https://www.researchgate.net/publication/312614653_Reconciling_fisheries_catch_and_ocean_productivity).

# Updates from previous assessment

* No longer using gear type to classify catch data as high or low bycatch, since the IMAS data now provides values for **discards**, which we consider as bycatch. 
* Previously, the raw catch data was all in a single file. This year, we have to combine across three different data tables: catch data (CatchInd_XXXX_XXXX), master index file with country name, species, etc (Index.csv), and geospatial information (Cells.csv).
* Previously raw catch data was in tonnes/km^2^, but this year they are in tonnes. The area in km^2^ values are located in the Cells.csv file
* One other change from last year is that we will gapfill the missing NPP data prior to using

# Data Source

**Reference**: Watson, R. A. and Tidd, A. 2018. Mapping nearly a century and a half of global marine fishing: 1869â€“2015. Marine Policy, 93, pp. 171-177. [(Paper URL)](https://doi.org/10.1016/j.marpol.2018.04.023)

**Downloaded**: July 17, 2018 from [IMAS portal](http://data.imas.utas.edu.au/portal/search?uuid=ff1274e1-c0ab-411b-a8a2-5a12eb27f2c0) - clikc on download tab, step 3

**Description**:  Global fisheries landings data per cell separated by Industrial versus Non-Industrial catch, IUU, and discards.

**Native data resolution**:   

**Time range**: 1950 - 2015

**Format**:  CSV format

**Additional Information**: [Metadata](http://metadata.imas.utas.edu.au/geonetwork/srv/eng/metadata.show?uuid=ff1274e1-c0ab-411b-a8a2-5a12eb27f2c0), [Supplementary Material](https://ars.els-cdn.com/content/image/1-s2.0-S0308597X18300605-mmc1.docx)


***
  
# Setup

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}

library(tidyverse)
library(purrr)
library(here) # install.packages("here")
setwd(here::here("globalprep","prs_fish","v2018"))

source("https://rawgit.com/OHI-Science/ohiprep_v2018/master/src/R/common.R")

rawFolder <- file.path(dir_M, "git-annex/globalprep/_raw_data/IMAS_GlobalFisheriesLandings/d2018")

```

# Import Raw Data

* Industrial Catch (1950 - 1954) - reported, iuu, and discard catch data for each cell location and unique identifier
* Master Index File (Index.csv) - information associated with the unique identifiers in the Industrial Catch data
* Spatial Cells Reference (Cell.csv) - contains geospatial information associated wtih the Industrial Catch data

```{r}

## Save download url suffixes 
web_years <- c("Ind_1950_1954", "Ind_1955_1959", "Ind_1960_1964", "Ind_1965_1969", 
               "Ind_1970_1974", "Ind_1975_1979", "Ind_1980_1984", "Ind_1985_1989",
               "Ind_1990_1994", "Ind_1995_1999", "Ind_2000_2004", "Ind_2005_2009", 
               "Ind_2010_2014", "Ind_2015_2019", "NInd_1950_1954", "NInd_1955_1959",
               "NInd_1960_1964", "NInd_1965_1969", "NInd_1970_1974", "NInd_1975_1979",
               "NInd_1980_1984", "NInd_1985_1989", "NInd_1990_1994", "NInd_1995_1999", 
               "NInd_2000_2004", "NInd_2005_2009", "NInd_2010_2014", "NInd_2015_2019")

reference <- c("Cells", "Index")

## Download reference data from web and save into mazu
for(ref in reference){ # ref <- "Ind_1950_1954"
  
  data <- read.csv(sprintf("http://data.imas.utas.edu.au/attachments/ff1274e1-c0ab-411b-a8a2-5a12eb27f2c0/%s.csv", ref))
  
  write.csv(data, file.path(dir_M, sprintf("git-annex/globalprep/_raw_data/IMAS_GlobalFisheriesLandings/d2018/%s.csv", ref)), row.names=F)
  
}

## Download catch data from web and save into mazu
for(web_year in web_years){ # web_year <- "Ind_1950_1954"

data <- read.csv(sprintf("http://data.imas.utas.edu.au/attachments/ff1274e1-c0ab-411b-a8a2-5a12eb27f2c0/Catch%s.csv", web_year))

saveRDS(data, file.path(dir_M, sprintf("git-annex/globalprep/_raw_data/IMAS_GlobalFisheriesLandings/d2018/Catch%s.rds", web_year)))

}

```

# Explore Data

Read in Master Index file, Spatial cells, and a single 5-year Catch dataset. 

Filter master file to only include `ID`, `Year`, `CountryName`, `TaxonName`, `CommonName`, `FleetGearName` (I actually don't think we will need the `CountryName` or `FleetGearName`, but it might be interesting).

```{r}

## Master index file
master <- read.csv(file.path(rawFolder,"Index.csv")) %>% 
  select(ID, Year, CountryName, TaxonName, CommonName, FleetGearName)
DT::datatable(head(master))

## Spatial cells reference
spatialCells <- read.csv(file.path(rawFolder,"Cells.csv"))
DT::datatable(head(spatialCells))

```

```{r}

## Look at single catch file
data <- readRDS(file.path(rawFolder,"CatchInd_1950_1954.rds"))
DT::datatable(head(data))

```

Test to see whether the values for **IndReported**, **IndIUU**, and **IndDiscards** in the Master Index File are sum totals of Clams cockles arkshells in the Republic of Korea in year 1953.
```{r}

korea_clam <- data %>% 
  filter(ID == 491423) %>% 
  mutate(tot_Reported = sum(Reported),
         tot_IUU = sum(IUU),
         tot_Discards = sum(Discards))

master_check <- master %>%
  filter(ID == 491423)

## IndReported, IndIUU, IndDiscards should match tot_Reported, tot_IUU, and tot_Discards
DT::datatable(head(korea_clam))
head(master_check)

```

# Methods

## Wrangle 

### Tidy Fisheries Files

1. Combine the Master Index and Spatial Cells with the CatchInd and CatchNInd files.
2. Save each year of data as a separate file into: "globalprep/_raw_data/IMAS_GlobalFisheriesLandings/d2018/int"

**Function for Combining & Saving Files**: Create function to read in each file name, combine with Index and Cells data frame, and save each year of catch data into a separate file in mazu.

```{r}

## Set function to read in each file, combine with Index.csv and Cells.csv, and save each year of data back into mazu
combine_fis <- function(x) {

  ## Read in the catch data
  ## Create a total Landings column
  ## Join with master and spatial cells file
  df <- readRDS(x) %>%
    mutate(Landings = Reported+IUU) %>% 
    left_join(master, by = "ID") %>% 
    left_join(spatialCells, by = "Cell")
  
  
  ## Save each individual year as a single file
  five_years <- sort(unique(df$Year)) 
  
  for(yr in five_years){
    print(yr) # will show you your progress
    
    single_yr_df <- df %>%
      filter(Year == yr)
    
    ## Save files with prefix CatchInd or CatchNInd
    ## Remove the suffix starting with '_' to get CatchInd or CatchNInd
    ind_Nind <- basename(x) %>% 
      tools::file_path_sans_ext() %>% 
      str_remove("_.*") # remove everything after the first underscore
    
    write_rds(single_yr_df, paste0(rawFolder, "/int/", ind_Nind, "_", yr, ".rds"))
    
  }
  
  }

```

**Industrial Catch Data**

Create list of industrial catch file names and apply the `combine_fis` function to save each individual 5-year interval catch data. Then, create a single file that has all years of data.

```{r}

ind_files <- dir(rawFolder, pattern ="CatchInd", full.names=TRUE)

## Wrangle and Save Each Year of Data Separately
indCatch <- map_df(ind_files, combine_fis)

```

**Non-industrial Catch Data**

Create list of non-industrial catch file names and apply the `combine_fis` function to save each individual 5-year interval catch data. Then, create a single file that has all years of data.

```{r}

nind_files <- dir(rawFolder, pattern ="CatchNInd", full.names=TRUE)

## Wrangle and Save Each Year of Data Separately
nindCatch <- map_df(nind_files, combine_fis)

```


### Create Annual Catch Rasters

We want a landings raster and a discards raster for Industrial (commericial) and Non-Industrial (artisanal) data per year. 

Note: Annual catch per cell contains values in units of kg per km^2^. Since values in `Reported`, `Discards`, `Landings`, and `IUU` are in tonnes, they must be first converted to kg then divided by the `Area` column.

1. Setup 
```{r}

library(tidyverse)
library(parallel)
library(foreach)
library(doParallel)
library(raster)
library(rasterVis)
library(seaaroundus)
library(RColorBrewer)
library(cowplot)
library(stringr)

registerDoParallel(5) # registering cores for parallel processing

ocean <- raster::raster(file.path(dir_M, 'model/GL-NCEAS-Halpern2008/tmp/ocean.tif'))

options(scipen=999)

## color palette
cols = rev(colorRampPalette(brewer.pal(11, 'Spectral'))(255)) # rainbow color scheme
mytheme=rasterTheme(region=cols)

## set mollweide projection CRS
mollCRS=crs('+proj=moll +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +units=m +no_defs')

```

2. First get the template raster with a resolution of 0.5 degree cells. The getcells() function comes from the seaaroundus R package.

The values of these cells are the Cell ID numbers. In the fisheries catch dataset, these Cell ID numbers match up with the "Seq" numbers.

```{r}

saup_cells <- getcells("POLYGON ((-180 90, 180 90, 180 -90, -180 -90, -180 90))")

saup_rast <- raster(ncol=720, nrow=360)
saup_rast[] <- saup_cells
   
plot(saup_rast,col=cols,main = "SAUP Cell IDs")

```

3. Create commercial and artisanal rasters

* comm_landings_XXXX.tif
* comm_discards_XXXX.tif
* artisanal_landings_XXXX.tif
* artisanal_discards_XXXX.tif

Catch data is in tonnes, so need to convert to kg then divide by `Area` (km^2^) to get catch per area. Since `Cell` is the identifier for a specific 30-min spatial cell, we want to add up total landings and total discards grouped by `Cell`.

Note: Subset for data 2003 and onwards since NPP data starts at 2003. Since we will be taking 5-year averages, we will need years 1999-2003 to get the average value for year 2003.

```{r}

## Specify years of data, file locations, raster output location
years = c(1999:2015)
annual_files <- list.files(file.path(rawFolder, "int"), full.names=TRUE)
rastFolder <- paste0(dir_M,"/git-annex/globalprep/prs_fish/v2018/int/")

## Specify a list of arguments - commercial or artisanal - for reading in data and saving raster file name
raw_suffx <- list(catchind = "CatchInd", catchnind = "CatchNInd")
rast_prefx <- list(comm = "comm", artisanal = "artisanal")

## Function for totalling landings/discards and saves raster files 
catch2raster <- function(raw_suffx,rast_prefx){
  
foreach(yr = years) %dopar% { #yr = 2003
  
  ## find file path of the respective year of data
  yr <- as.character(yr)
  ## Select the respective year of industrial catch data
  dataname <- str_subset(annual_files, paste0(raw_suffx,"*.",yr))
  ## read in raw data
  raw_data <- readRDS(dataname)
 
  ## Total Landings per Cell
  landings <- raw_data %>%
    dplyr::mutate(Landings_CR = (Landings * 1000)/Area) %>% # convert to catch rate (kg/km^2)
    dplyr::group_by(Cell) %>%
    dplyr::summarise(cell_catch = sum(Landings_CR, na.rm=TRUE)) %>% # usually no NAs, but just in case
    dplyr::ungroup()

  ## Total Discards per Cell
  discards <- raw_data %>%
    dplyr::mutate(Discards_CR = (Discards * 1000)/Area) %>% 
    dplyr::group_by(Cell) %>%
    dplyr::summarise(cell_catch = sum(Discards_CR)) %>% 
    dplyr::ungroup()
  
  ## Rasterize Catch: swapping template cell values with those in dataframe
  raster::subs(saup_rast, landings, by = "Cell", which = "cell_catch", subsWithNA=TRUE, 
               filename = paste0(rastFolder, rast_prefx, '_landings/annual_catch_', yr ,'.tif'), overwrite=TRUE)
  raster::subs(saup_rast, discards, by = "Cell", which = "cell_catch", subsWithNA=TRUE, 
               filename = paste0(rastFolder, rast_prefx, '_discards/annual_catch_', yr ,'.tif'), overwrite=TRUE) 
  
  }
}

## Applies catch2raster function on commercial (industrial) then artisanal (non-industrial) files
create_rast <- map2(raw_suffx, rast_prefx, catch2raster)

```

### Check Rasters

```{r}

commercial <- list.files(paste0(rastFolder,"comm_landings"),full.names = TRUE)
check_rast <- raster(commercial[17])
plot(check_rast)
click(check_rast)

```


# Gapfill

# Data Checks

