---
title: "Untitled"
author: "Iwen Su"
output: html_document
---


```{r}

## Libraries
library(dplyr)
library(tidyr)
library(readr)
library(sf)
library(ggplot2)
library(stringr)
library(here) 
setwd(here::here("globalprep","fis","v2018"))

source('../../../src/R/common.R')

```

## Identify Newly Added Stocks
```{r}

## old stocks
load(file.path(dir_M, "git-annex/globalprep/_raw_data/RAM/d2017/RAM v3.80/DB Files With Assessment Data/DBdata.RData"))

ram_bmsy_old <- data.frame(timeseries) %>%
  dplyr::filter(tsid == "BdivBmsytouse-dimensionless") %>%
  dplyr::filter(!is.na(tsvalue)) %>%
  dplyr::mutate(tsyear = as.numeric(as.character(tsyear))) %>%
  dplyr::filter(tsyear > 1979) %>%
  dplyr::select(assessid, year=tsyear, ram_bmsy = tsvalue, stockid, stocklong)

old_stocklong <- unique(ram_bmsy_old$stocklong)
old_stockid <- unique(ram_bmsy_old$stockid)
old_assessid <- unique(ram_bmsy_old$assessid)

## new stocks
load(file.path(dir_M, "git-annex/globalprep/_raw_data/RAM/d2018/RAM v4.40 (6-4-18)/DB Files With Assessment Data/DBdata.RData"))

ram_bmsy <- data.frame(timeseries) %>%
  dplyr::filter(tsid == "BdivBmsytouse-dimensionless") %>%
  dplyr::filter(!is.na(tsvalue)) %>%
  dplyr::mutate(tsyear = as.numeric(as.character(tsyear))) %>%
  dplyr::filter(tsyear > 1979) %>%
  dplyr::select(assessid, year=tsyear, ram_bmsy = tsvalue, stockid, stocklong)

new_stocklong <- unique(ram_bmsy$stocklong)
new_stockid <- unique(ram_bmsy$stockid)
new_assessid <- unique(ram_bmsy$assessid)

## find diff
setdiff(new_stocklong, old_stocklong)
newStocks <- setdiff(new_stockid, old_stockid); length(newStocks)
setdiff(new_assessid, old_assessid)



```


Subset for just new stocks in 2018 RAM data - for some reason, some of the id prefixes specifying RAM regions are not found in the RLSADB v4.40 excel file
```{r}

ram_bmsy <- ram_bmsy %>% 
  filter(stockid %in% newStocks)

## some stockid values are repeated in more than one observation due to multiple assessid years
id_new <- ram_bmsy %>% 
  select(assessid, stockid, stocklong) %>% 
  distinct()

```


## Add Stock Info to Old RAM_fao_ohi_rgns

Combine the data table Mel created `RAM_fao_ohi_rgns` that contains fao id, ohi id, and assessid from RAM with the old RAM data to match each row with the appropriate stockid and stocklong information
```{r}
## Grab last year's fao-ohi-assessid data table
RAM_fao_ohi_rgns <- read.csv("../v2017/int/RAM_fao_ohi_rgns.csv")

## create unique values of assessid, stock id, and stock long
id_old <- ram_bmsy_old %>% 
  select(assessid, stockid, stocklong) %>% 
  distinct()

## join tables
all_old <- RAM_fao_ohi_rgns %>% 
  full_join(id_old, by="assessid")

```

## Combine New and Old Stock Data

```{r}

RAM_rgns_new <- all_old %>% 
  full_join(id_new, by = c("assessid","stockid","stocklong"))

write.csv(RAM_rgns_new, "int/RAM_fao_ohi_rgns.csv", row.names=FALSE)
```

## Fill Region IDs for New Stocks

Investigate what FAO/OHI region each stock belongs to: 
* Full intermediate stock data table [here](https://github.com/OHI-Science/ohiprep_v2018/blob/master/globalprep/fis/v2018/int/RAM_fao_ohi_rgns.csv)
* Primarily used www.fishsource.org to find stock distribution information. 
* Referenced FAO_AREAS (filtered for MAJOR) and ohi_fao_rgns shapefile from mazu on ArcGIS (can use other map visuals to identify stock extent). 
* Searched and tested key words in data table viewer (`DT::datatable`) to use in `str_detect`. See which stocks have the same FAO id assignment(s).

Some regions have more than 1 `fao_id` or `rgn_id` (e.g. Alaska skate Bering Sea and Aleutian Islands,	Kamchatka flounder Bering Sea and Aleutian Islands have `fao_id` 61 and 67)

```{r}

RAM <- RAM_filt %>% 
  ## ADDING FAO REGION ID
  mutate(fao_id = 
           case_when(
             str_detect(stocklong, paste(c("Bering Sea","Gulf of Alaska$"), collapse = "|")) ~ 61,
             str_detect(stocklong, "Sicily$") ~ 37,
             str_detect(stocklong, paste(c("^Jackass morwong Western","^Jackass morwong Eastern","Redfish Eastern Australia","Blue grenadier New South Wales"), collapse = "|")) ~ 57,
             str_detect(stocklong, paste(c("Scotian Shelf","Haddock","NAFO"), collapse = "|")) ~ 21,
             str_detect(stocklong, paste(c("Japan", "Mikawa Bay", "East China Sea", "Tsushima Strait","Kichiji", "^Pacific cod North", "Northwest Pacific", "Snow crab North Pacific", "Willowy flounder North Pacific"), collapse = "|")) ~ 61
           )) %>% 
  mutate(fao_id_2 =
           case_when(
             str_detect(stocklong, "Bering Sea") ~ 67,
             str_detect(stocklong,  paste(c("^Jackass morwong Eastern","Redfish Eastern Australia","Blue grenadier New South Wales"), collapse = "|")) ~ 81
             )) %>% 
  
  ## ADDING OHI REGION ID
  mutate(rgn_id = 
           case_when(
             str_detect(stocklong, paste(c("Bering Sea","Gulf of Alaska$"), collapse = "|")) ~ 163,
             str_detect(stocklong, "Sicily$") ~ 184,
             str_detect(stocklong, "Australia$") ~ 16,
             str_detect(stocklong, paste(c("Scotian Shelf","NAFO"), collapse = "|")) ~ 218,
             str_detect(stocklong, "^Haddock Georges") ~ 163,
             str_detect(stocklong, paste(c("Japan","Tsushima Strait", "East China Sea$", "^Kichiji", "^Pacific cod North", "Northwest Pacific", "Snow crab North Pacific", "Willowy flounder North Pacific"), collapse = "|")) ~ 210
           )) %>% 
  mutate(rgn_id_2 =
           case_when(
             str_detect(stocklong, paste(c("Bering Sea", "Japanese anchovy Pacific Coast", "Japanese sardine Pacific Coast", "Northwest Pacific", "Snow crab North Pacific"), collapse = "|")) ~ 73,
             str_detect(stocklong, "Sicily$") ~ 68,
             str_detect(stocklong, paste(c("Japanese flying squid", "Tsushima Strait", "East China Sea$", "Willowy flounder North Pacific"), collapse="|")) ~ 20
           )) %>% 
  mutate(rgn_id_3 =
           case_when(
              str_detect(stocklong, "Sicily$") ~ 61,
              str_detect(stocklong, paste(c("Japanese flying squid", "Tsushima Strait","East China Sea$", "Willowy flounder North Pacific"), collapse="|")) ~ 209,
              str_detect(stocklong, "Snow crab North Pacific") ~ 20
           )) %>% 
  mutate(rgn_id_4 = 
           case_when(
             str_detect(stocklong, "Snow crab North Pacific") ~ 21
           ))
             
DT::datatable(RAM,rownames = F)
```

