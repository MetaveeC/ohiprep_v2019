---
title: 'OHI 2019: Seagrass extent'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    toc: true
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ohiprep/src/templates/ohi_hdr.html'
  pdf_document:
    toc: true
---

# Summary

This script generates the extent of seagrass for each OHI region. 


## Updates from previous assessment
Creating an actual script to calculate this. This has not been updated since 2012. Updating the data with newest version of data (version 6). 

***
## Data Source 

**Downloaded**: 07/15/2019

**Description**:  
Global Distribution of Seagrasses
https://data.unep-wcmc.org/datasets/7
Reported at spatial cell scale. 

This dataset shows the global distribution of seagrasses, and is composed of two subsets of point and polygon occurence data. The data were compiled by UNEP World Conservation Monitoring Centre in collaboration with many collaborators (e.g. Frederick Short of the University of New Hampshire), organisations (e.g. the OSPAR Convention for the Northeast Atlantic sea), and projects (e.g. the European project Mediterranean Sensitive Habitats "Mediseh"), across the globe (full list available in "Metadata_Seagrass.dbf").

**Time range**: 1934-2015


***
# Methods
Reclassify the seagrass extent data into a mask of 1 or NoData, and then compute zonal statistics for the count of cells within an OHI region that have seagrass and then convert into km2.


## Setup
``` {r setup, echo = FALSE, message = FALSE, warning = FALSE}
library(readr)      # for read_csv()
library(raster)
library(here)
library(sf)
library(fasterize)
library(tidyverse)

source(here('workflow/R/common.R'))

goal     <- 'globalprep/hab_seagrass/v2019'
dir_git  <- file.path('~/github/ohiprep_v2019', goal)
dir_wcmc <- file.path(file.path(dir_M, 'git-annex/globalprep/_raw_data/wcmc_seagrass'))
ohi_rasters() # call the region zones raster
```

```{r}
habitat_extent_seagrass_updated <- read_csv("~/github/ohiprep_v2019/globalprep/hab_seagrass/v2012/data/habitat_extent_seagrass_updated.csv")

v6_seagrass_pts <- sf::st_read(dsn = file.path(dir_wcmc, "014_001_WCMC013-014_SeagrassPtPy2018_v6/01_Data"), layer = "WCMC_013_014_SeagrassesPt_v6")

v3_seagrass_pts <- sf::st_read(dsn = file.path(dir_wcmc, "DataPack-WCMC-013-014-SeagrassPointsPolygons2005-ver3"), layer = "WCMC-013-SeagrassPoints2005-ver3")

v6_seagrass_py <- sf::st_read(dsn = file.path(dir_wcmc, "014_001_WCMC013-014_SeagrassPtPy2018_v6/01_Data"), layer = "WCMC_013_014_SeagrassesPy_v6")

v3_seagrass_py <- sf::st_read(dsn = file.path(dir_wcmc, "DataPack-WCMC-013-014-SeagrassPointsPolygons2005-ver3"), layer = "WCMC-014-SeagrassPolygons2005-ver3")


```

**Convert seagrass shapefiles into same CRS as our region zones raster**
```{r}

moll_crs <- crs(zones, asText = TRUE)

v6_seagrass_pts_moll <- st_transform(v6_seagrass_pts, crs = moll_crs) #project points shapefile to match zones crs
crs(v6_seagrass_pts_moll) #check to see it worked

v6_seagrass_py_moll <- st_transform(v6_seagrass_py, crs = moll_crs)
crs(v6_seagrass_py_moll)
plot(v6_seagrass_py_moll[1])
plot(zones)
```

**Fasterize/rasterize: Where there is seagrass assign a value of 1 and NA otherwise**
```{r}

## convert from multipoint to point
v6_seagrass_pts_moll_cast <- st_cast(v6_seagrass_pts_moll, "POINT")

#convert to a spatial type 
v6_seagrass_pts_moll_spat <- as(v6_seagrass_pts_moll_cast, "Spatial")
#create a column full of "1's"
v6_seagrass_pts_moll_spat$raster <- 1
#rasterize our points data to raster 
rasterize_pts <- raster::rasterize(v6_seagrass_pts_moll_spat, zones, "raster", fun = min)

plot(v6_seagrass_pts_moll_spat)
plot(rasterize_pts)
zoom()
#cell stats sum - should be similar to dim
cellStats(rasterize_pts, stat = "sum") #9331 

writeRaster(rasterize_pts, file.path(dir_M, "/git-annex/globalprep/hab_seagrass/v2019/int/pt_seagrass_rast.tif"))
rasterize_pts <- raster(file.path(dir_M, "/git-annex/globalprep/hab_seagrass/v2019/int/pt_seagrass_rast.tif"))


#fasterize our polygon dataset into a raster
fasterize_py <- fasterize::fasterize(v6_seagrass_py_moll, raster = zones, 
                                     field = NULL) # all polygons given value of 1

plot(fasterize_py)

writeRaster(fasterize_py, file.path(dir_M, "/git-annex/globalprep/hab_seagrass/v2019/int/py_seagrass_rast.tif"))
fasterize_py <- raster(file.path(dir_M, "/git-annex/globalprep/hab_seagrass/v2019/int/py_seagrass_rast.tif"))

#check to see if all points are 0 and 1 for points raster
check_values_points <- getValues(rasterize_pts)
sum(check_values_points == 1, na.rm = TRUE)
#9331
sum(is.na(check_values_points))
#745356719
unique(check_values)
#NA 1

#check to see if all points are 0 and 1 for polygon raster

check_values_py <- getValues(fasterize_py)
sum(check_values_py == 1, na.rm = TRUE)
#371329
sum(is.na(check_values_py))
#744994721
unique(check_values_py)
#NA 1
```

**Stack rasters and adjust**
```{r}
stacked_seagrass <- raster::stack(rasterize_pts, fasterize_py)
plot(stacked_seagrass)

sum_seagrass <- raster::calc(stacked_seagrass, fun = sum, na.rm = TRUE)
plot(sum_seagrass)

writeRaster(sum_seagrass, file.path(dir_M, "/git-annex/globalprep/hab_seagrass/v2019/int/combined_pt_py.tif"), overwrite = TRUE)

sum_seagrass <- raster(file.path(dir_M, "/git-annex/globalprep/hab_seagrass/v2019/int/combined_pt_py.tif"))

#check values in combined_seagrass
combined_values <- getValues(sum_seagrass)
unique(combined_values)
sum(combined_values == 1, na.rm = TRUE) #377618
sum(combined_values == 2, na.rm = TRUE) #1521
sum(combined_values == 0, na.rm = TRUE) # 744986911 -- these are all of the NAs

## Need to assign all "2's" as "1's" and all "0's" as "NA". There are 2s because 1+1=2. 
combined_seagrass <- sum_seagrass

#assign all 2 to 1 
combined_seagrass[combined_seagrass == 2] <- 1
combined_values_2 <- getValues(combined_seagrass)
sum(combined_values_2 == 2, na.rm = TRUE) #should  be 0... it is
sum(combined_values_2 == 1, na.rm = TRUE) #should be 377618 + 1521 = 379139... it is
sum(combined_values == 0, na.rm = TRUE) # should be 744986911... 

#assign all 0 to NA
combined_seagrass[combined_seagrass == 0] <- NA
combined_values_3 <- getValues(combined_seagrass)
sum(combined_values_3 == 0, na.rm = TRUE) # check to see if it worked -- should be 0... it is
sum(is.na(combined_values_3)) #should be 744986911... it is

writeRaster(combined_seagrass, file.path(dir_M, "/git-annex/globalprep/hab_seagrass/v2019/int/combined_pt_py_adjusted.tif"), overwrite = TRUE)

combined_seagrass <- raster(file.path(dir_M, "/git-annex/globalprep/hab_seagrass/v2019/int/combined_pt_py_adjusted.tif"))
```

**Calculate zonal stats with zones raster and new combined seagrass. Convert to km^2 and save int/output files**
```{r}
zonal_sums_combined <- raster::zonal(combined_seagrass, zones, fun = "sum", na.rm = TRUE) #sum all seagrass cells for each ohi zone

summary(zonal_sums_combined)

zonal_sums_combined_df <- data.frame(zonal_sums_combined)

zonal_sums_km2 <- zonal_sums_combined_df %>%
  mutate(year = 2019, habitat = "seagrass",
         km2 = (0.934478877011218970**2*sum)) %>% #one cell is equal to ~0.93 km
  rename("rgn_id" = "zone") %>%
  select(-sum)

write_csv(zonal_sums_km2, file.path(dir_git, 'int/habitat_extent_seagrass_raw.csv')) #save into intermediate data folder

#compare new and old data
compare_habitat_extent <- zonal_sums_km2 %>%
  left_join(habitat_extent_seagrass_updated, by = "rgn_id") %>%
  mutate(km2.y = ifelse(
    km2.x >0 & is.na(km2.y) ,0,
    km2.y
  ))

ggplot(compare_habitat_extent, aes(x = km2.y, y = km2.x)) +
  geom_point() +
  geom_abline() +
  labs(title = "Seagrass Habitat version 3 vs version 6", x = "version 3 extent", y=  "version 6 extent") +
  theme_bw()

#Find which regions to classify as NA in our new data... i.e. regions in the new extent which have 0 km2 and that have NA km2 in old data
compare_hab_NAs <- compare_habitat_extent %>%
  filter(km2.x == 0, is.na(km2.y))

NA_rgns <- c(compare_hab$rgn_id)

#Now assign NA values to all of the regions without seagrass extent. Also filter out weird huge rgn_ids
zonal_sums_km2_all_rgns <- zonal_sums_km2 %>%
  mutate(km2 = ifelse(
    rgn_id %in% NA_rgns,
    NA,
    km2
  )) %>%
  filter(rgn_id <= 277)

write_csv(zonal_sums_km2_all_rgns, file.path(dir_git, 'int/habitat_extent_seagrass_all_rgns.csv'))

#create final dataset and save
zonal_sums_km2_final <- zonal_sums_km2_all_rgns %>%
  filter(!is.na(km2))
write_csv(zonal_sums_km2_all_rgns, file.path(dir_git, 'data/habitat_extent_seagrass_final.csv'))

```






