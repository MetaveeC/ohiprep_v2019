---
title: 'OHI 2018 - Clean Water - Pathogen Pollution: Preparing Sanitation data'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: show
    toc: true
    toc_depth: 1
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '../../../src/templates/ohi_hdr.html'
pdf_document:
  toc: true
editor_options: 
  chunk_output_type: console
---

[REFERENCE RMD FILE:
]

# Summary
[general description: What data are being generated? Why (what project, etc.)? Upstream/downstream processing information that might be helpful?  Other information?]

This document describes the steps for preparing the pathogen pollution and pathogen pollution trend data layers for the 2018 global assessment.
The percentage of the population with access to improved sanitation facilities (World Health Organization and United Nations Childrenâ€™s Fund, Joint Monitoring Programme, 2011) was used in combination with measurements of coastal population as a proxy for pathogens in coastal waters. Access to improved sanitation facilities is defined as the percentage of the population in a country with at least adequate access to disposal facilities that can effectively prevent human, animal, and insect contact with excreta. These data are a country-wide average (not specific to the coastal region). Percentages (0-100) for each country were rescaled to 0-1 based on a maximum target of 100% of the population with access to improved sanitation, and a minimum value of 0.


# Updates from previous assessment
Data source (WHO-UNICEF) updated the way they reported the data. However, the 2018 assesment is calculated using the "At least Basic" data becuse it is consistent with what have been used in previous assesmentes and the data is more complete. 

**Consider for future assesments: make the "Safely managed" data more complete, and reconsider whether these data would be better to use.

Deffinition of each variable according to the data source:
"At leasr basic": Use of improved facilities that are not shared with other households.

"Safely managed": Use of improved facilities that are not shared with other households and where excreta are safely disposed of in situ or transported and treated offsite

***

# Data Source [NOTE: can be copied from README.md in rawdata file]
**Reference**: 
            https://washdata.org/data
            Updated July 2017

**Downloaded**: Downloaded 5/1/2018

**Description**:  Percentage of the population that has access to improved facilities that are not shared with other households (At a basic level).

Access to improved sanitation facilities is defined as the percentage of the population within a country with at least adequate access to excreta disposal facilities that can effectively prevent human, animal, and insect contact with excreta.

**Native data resolution**: country-wide average (not specific to the coastal region)

**Time range**: 2000 - 2015

**Format**:  csv saved in github (Also find the raw data in Maxu: git_annex/globalprep/raw_data/WHO_UNICEFF)

***
  
# Methods
[R code used to generate the data. Or, alternatively, description of the code/data files used to generate the data.]

Percentages (0-100) for each country were rescaled to 0-1 based on a maximum target of 100% of the population with access to improved sanitation, and a minimum value of 0.

***

# Citation information  
[citation information: include if these data will have their own specific citation.]


#Setup

```{r}
## set working directory; comment out for knitting
# setwd("~/github/ohiprep_v2018/globalprep/prs_cw_pathogen/v2018")

##Packages
library(ohicore) # devtools::install_github('ohi-science/ohicore') # may require uninstall and reinstall
library(zoo)     # for na.locf: Last Observation Carried Forward
library(tidyverse)

```

#Import raw data

```{r}
##Directly from Mazu

#CHECK TO SEE IS I NEED THIS
##reads in the directory path to Mazu based on operating system 
source("https://raw.githubusercontent.com/OHI-Science/ohiprep_v2018/master/src/R/common.R")
source('../../../src/R/common.R')


##From Mazu
sani_raw_M <- read.csv(file.path(dir_M, "git-annex/globalprep/_raw_data/WHO_UNICEFF/d2018/JMP_2017_WLD.csv"),  header = FALSE, sep = ",", na.strings = c(NA, ''), skip = 2, stringsAsFactors = FALSE, strip.white = TRUE)

##From github
sani_raw <- read.csv('https://raw.githubusercontent.com/OHI-Science/ohiprep_v2018/master/globalprep/prs_cw_pathogen/v2018/raw/JMP_2017_WLD.csv',  header = FALSE, sep = ",", na.strings = c(NA, ''), skip = 2, stringsAsFactors = FALSE, strip.white = TRUE) #some of the data has spaces before or at the end, stripe.white removes this

```

#Methods

##Data wrangling
Selecting and naming the columns of interest. Scale the percentage of population with access to improved sanitation to popoportions (from 0-1). Transform population and percentage into a numeric variable.


```{r}
sani <- sani_raw %>%
  select(country = V1,
         year = V3,
         pop = V4,
         basic_pct = V6) %>%
  mutate(pop = str_remove_all(pop, pattern = " ")) %>%
  mutate_at(.vars = c("pop", "basic_pct"), .funs = as.numeric)%>%
  mutate(pop = pop * 1000,
          basic_prop = basic_pct/100)

```


Change names of regions to match names in ohicore and fileter out regions that are not part of the OHI assesment or do not have data.

If after running 'name_2_rgn' (see next r chunk), there are other coastal regions that are not identified. They must be checked and see what is the proper way to include them (or not include them).

```{r}

sani_improved <- sani %>%
   mutate(country = ifelse(str_detect(country,"Cura\\Sao"), "Curacao", country))%>% 
   mutate(country = ifelse(str_detect(country,"R\\Sunion"), "Reunion", country)) %>% 
   mutate(country = ifelse(str_detect(country, "C\\Ste d\\SIvoire"), "Ivory Coast", country)) %>% 
   mutate(country=ifelse(str_detect(country,"Hong Kong"), "Hong Kong", country)) %>% 
   mutate(country=ifelse(str_detect(country,"Macao"), "Macao", country))

##For 2018 assesment
##Caribbean Netherlands are in a lowe resolution than hte OHI regions. They include: Bonaire, Sint Eustatius, Saba. However, there is no data Caribbean Netherlands so it is filter out.
sani_improved <- sani_improved %>% 
  filter(country!= 'Caribbean Netherlands')

##If there was data for Caribbean Netherlands this is how to use the data of this region for Bonaire, Sint Eustatius, Saba

# CN <- filter(sani_improved, country=="Caribbean Netherlands") %>%
#   rename(country_old = country)
# CN_subregions <- data.frame(country_old = "Caribbean Netherlands",
#                             country = c("Bonaire", "Sint Eustatius", "Saba")) %>%
#   left_join(Carribean_neth) %>%
#   select(-country_old)
# sani_improved <- sani_improved %>%
#   filter(country != "Carribean Netherlands") %>%
#   rbind(CN_subregions)  

#Channel Islands correspond to OHI regions of Guernsey and Jersey. Here the data reported for Channel Islands is used for these two regions.

CI <- filter(sani_improved, country=="Channel Islands") %>%
  rename(country_old = country)
CI_subregions <- data.frame(country_old = "Channel Islands",
                            country = c("Guernsey", "Jersey")) %>%
  left_join(CI) %>%
  select(-country_old)

sani_improved <- sani_improved %>%
  filter(country != "Channel Islands") %>%
  rbind(CI_subregions)  

```

Add rgn_id. 

```{r}
rgn_sani <- name_2_rgn(sani_improved, 
                        fld_name     = 'country',
                        flds_unique  = c('country','year')) 

##Warning: These data were removed for not having any match in the lookup tables.
## Check list in warning to make sure all countries removed are not of interest for the OHI global assesment. In this case West Bank and Gaza Strip is not considered because it is a disputed area and Isle of Man is not consider an OHI region.

##Check for duplicate regions.
sort(table(rgn_sani$rgn_id)) #for this analysis regions which are duplicated are: rgn_id = 209, 140, 116, 13

## Each region has 16 years of data in this case. If there are regions with more than 16 values is because in this database they are resported in a higher resolution than the OHI global assesment (eg: China, Hong Kong and Macao are just one region for the OHI global). For these regions a weighted average will be calculated as its final score.


##Finalizing the first part of the sanitation preparation by calculating weighted means for the duplicated regions.

sani_final <- rgn_sani %>% 
  group_by(rgn_id, rgn_name, year) %>% 
  summarise(basic_sani_prop= weighted.mean(basic_prop, pop, na.rm = TRUE))

##Check for duplicate regions. If weighed average where included then all rgn_id have 16 values of data.
sort(table(sani_final$rgn_id))

```

#Gapfilling

First step is to get an idea of what needs to be gapfilled.

```{r check}

sani_gf <- sani_final %>% 
  group_by(rgn_id, rgn_name) %>%
  mutate(gf_count = sum(is.na(basic_sani_prop)))

summary(sani_gf)
filter(sani_gf, gf_count>0) %>% 
  select(rgn_id, rgn_name, gf_count) %>% 
  unique() %>%
  data.frame()

##Some regions have no data. Filter those out to be gapfiled latter.

##Define number of years of data
years_data <- mean(table(sani_gf$rgn_id))

sani_gf <- sani_gf %>%
  filter(gf_count != years_data)

```

## Gapfilling 1: Linear model
Use a linear model within country data to estimate missing years.

```{r gf_lm}

sani_gf_lm <- sani_gf %>%
  group_by(rgn_id, rgn_name) %>%
  do({
    mod <- lm(basic_sani_prop ~ year, data = .)
    gf_lm <- predict(mod, newdata = .[c('year')])
    data.frame(., gf_lm)
  }) %>%
  ungroup()

summary(sani_gf_lm)

sani_gf_lm <- sani_gf_lm %>%
  mutate(gf_lm = ifelse(gf_lm > 1, 1, gf_lm)) %>% # constrain predictions to <1 
  mutate(method = ifelse(is.na(basic_sani_prop), "lm prediction", NA)) %>%
  mutate(basic_sani_prop = ifelse(is.na(basic_sani_prop), gf_lm, basic_sani_prop))
```


##Gapfilling 2

Georegional gapfilling for regions that do not have data.


```{r gf georgn}
##Bring from ohicore packege georegions and georegions lables as variables
georegions       <- georegions
georegion_labels <- georegion_labels

year <- min(sani_gf_lm$year):max(sani_gf_lm$year) #defines the year range

sani_georgn_gf <- georegions%>%
  expand(year, georegions)%>%
  left_join(sani_gf_lm, by = c('rgn_id', 'year')) %>%
  left_join(georegion_labels, by = 'rgn_id') %>%
  select(-r0)

##Identify inhabitaed regions
rgn_inhab <- read.csv('https://raw.githubusercontent.com/OHI-Science/ohiprep_v2018/master/src/LookupTables/rgn_uninhabited_islands.csv')

rgn_inhab <- rgn_inhab %>% 
  mutate(inhab = 1) %>% 
  select(rgn_id, inhab)

sani_georgn_gf <- sani_georgn_gf %>% 
  left_join(rgn_inhab, by= 'rgn_id')


##Calculate two different gapfill columns using r2 and r1
sani_georgn_gf <- sani_georgn_gf %>%
  group_by(year, r2) %>%
  mutate(basic_sani_r2 = mean(basic_sani_prop, na.rm=TRUE)) %>%
  ungroup() %>%
  group_by(year, r1) %>%
  mutate(basic_sani_r1 = mean(basic_sani_prop, na.rm=TRUE)) %>%
  ungroup()%>%
  arrange(rgn_id, year)


##First gapfill with r2, if no value available use r1; create column indicating whether value was gapfilled and if so, by what method.
sani_georgn_gf <- sani_georgn_gf %>%
  mutate(method = ifelse(is.na(basic_sani_prop) & !is.na(basic_sani_r2) & is.na(method) , "UN georegion (r2)", method)) %>%
  mutate(method = ifelse(is.na(basic_sani_prop) & is.na(basic_sani_r2) & !is.na(basic_sani_r1) & is.na(method), "UN georegion (r1)", method))%>%
  mutate(method = ifelse(is.na(inhab), method, 'inhab')) %>% 
  mutate(basic_sani_prop= ifelse(is.na(basic_sani_prop) & !is.na(basic_sani_r2), basic_sani_r2, basic_sani_prop)) %>%
  mutate(basic_sani_prop = ifelse(is.na(basic_sani_prop) & !is.na(basic_sani_r1), basic_sani_r1, basic_sani_prop))%>%
  mutate(basic_sani_prop = ifelse(is.na(inhab), basic_sani_prop, 1)) %>% #all inhabitated regions are given the maximun score 1.
  select(rgn_id, year, basic_sani_prop, method, inhab)

##See regions that have not been gapfilled
filter(sani_georgn_gf, is.na(basic_sani_prop)) %>% 
  select(rgn_id, basic_sani_prop) %>% 
  unique() %>%
  data.frame()

##Check for inhabited rigions
filter(sani_georgn_gf, !is.na(inhab)) %>% 
  select(rgn_id, basic_sani_prop, method) %>% 
  unique() %>%
  data.frame()

```


#Save gapfilled data

```{r}
#Save data
write.csv(sani_georgn_gf, "intermediate/sani_georgn_gf.csv", row.names=FALSE)

```


#Standarizing Sanitation data by population
```{r}
population <- read.csv("../../mar_prs_population/v2018/output/mar_pop_25mi.csv")%>%
  arrange(rgn_id, year)

##Keep an eye on not populated regions. They will have the highest score
#Note: there is a difference between the list of islands with no population in the mar_pop_25mi dataset witht the nhabit list in github. In the mar_pop_25mi, rgn_id 144 - Jan Mayen is not identified as a pop_0 region while in the github list it is.

#identify inhabited regions (popsum=0)
pop_0 <- population%>%
  filter(popsum==0)
sort(table(pop_0$rgn_id))

#Min and max year of data
minyear <- min(sani_georgn_gf$year)
maxyear <- max(sani_georgn_gf$year)

#standarization: convert proportion with acces to sanitation to proportion without access to sanitation (poopers! lack of access*population density)

unsani_pop <- sani_georgn_gf %>%  
    filter(year %in% minyear:maxyear) %>% 
    select(rgn_id, year, basic_sani_prop) %>%
    left_join(population %>%
                filter(year %in% minyear:maxyear), 
              by=c('rgn_id', 'year')) %>%
    mutate(propWO_x_pop     = (1 - basic_sani_prop) * popsum, # this is the population density of people without access
           propWO_x_pop_log = log(propWO_x_pop + 1))          # log is important because the skew was high otherwise

#Rescale to calculate score. Pressure is rescaled to 110% of max 'poopers' within past five years.
unsani_pop <- unsani_pop %>%
    mutate(pressure_score = propWO_x_pop_log / (1.1 * max(propWO_x_pop_log, na.rm = TRUE)))

#(havent saved)
#Save data pressure scores (ps)
#write.csv(unsani_pop, "intermediate/unsani_pop_ps.csv", row.names=FALSE)



```



#Model Trend
2017 update for new ohi-global framework

```{r}

#copied from update_2017.R

data <- data.frame()
for (year in 2012:2015){ # year = 2012
  trend <- read.csv(sprintf("globalprep/mar_prs_population/v2018/output/mar_pop25mi_trend_%sa.csv", year))
  
  trend <- trend %>%
    mutate(year = year) %>%
    select(rgn_id, year, trend)
  
  data <- rbind(data, trend)
  
}

write.csv(data, "globalprep/prs_cw_pathogen/v2018/output/pathogens_popdensity25mi_trend_updated.csv",
          row.names=FALSE)


# pressure data
data <- data.frame()

for (year in 2012:2015){ # year = 2012
  path_data <- read.csv(sprintf("globalprep/prs_cw_pathogen/v2015/data/po_pathogens_popdensity25mi_%sa.csv", year))
  
  path_data <- path_data %>%
    mutate(year = year) %>%
    select(rgn_id, year, pressure_score)
  
  data <- rbind(data, path_data)
  
}

write.csv(data, "globalprep/prs_cw_pathogen/v2016/output/pathogens_popdensity25mi_updated.csv",
          row.names=FALSE)

```




