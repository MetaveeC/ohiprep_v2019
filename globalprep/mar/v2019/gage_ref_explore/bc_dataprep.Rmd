---
title: 'OHIBC data prep: Mariculture'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'Figs/',
                      echo = TRUE, message = FALSE, warning = FALSE)
library(raster)
library(sf)
library(tidyverse)
source('http://ohi-science.org/ohiprep_v2019/workflow/R/common.R')
scenario <- 'v2019'
goal     <- 'mar'
dir_git  <- path.expand('~/github/ohiprep_v2019')
dir_goal <- file.path(dir_git, 'globalprep', goal, scenario)
dir_spatial <- file.path(dir_M, 'git-annex/globalprep/spatial')
dir_data  <- file.path(dir_M, 'git-annex/globalprep', '_raw_data')
#dir_biomass <- file.path(dir_goal, "biomass")

#library(provRmd); prov_setup()
#reload <- FALSE
### set up proj4string options: BC Albers and WGS84
#p4s_bcalb <- c('bcalb' = '+init=epsg:3005')
p4s_wgs84 <- c('wgs84' = '+init=epsg:4326')
```

# Summary: OHI Mariculture - Gage

This script prepares layers (production potential, area targets, harvest values) for Mariculture sub-goal. 

From Halpern et al. (2012) :

>The Status of the Mariculture sub-goal ($x_{MAR}$), was defined as production of strictly marine taxa from both the marine and brackish water FAO categories, excluding aquatic plants such as kelps and seaweeds, which were assumed to contribute predominantly to medicinal and cosmetic uses rather than as a source of food.
In addition, a sustainability factor is included for the global OHI calculations.

We will leverage Gentry, Froehlich et al. (2017) to determine aquaculture potential for both shellfish and finfish. For each OHIBC region, the $\Phi'$ value based on a generic portfolio of 120 finfish and 60 bivalves is converted into a time-to-harvest value for each 1-km^2 cell.  These in turn are converted to a potential harvest rate $P_c$ as a function of $\Phi'$.

To determine a reference point, we will create a rescaled harvest potential similar to the $B' = f(B/B_{MSY})$ score for the FIS subgoal. A score of 1 will reflect a harvest value greater than $\bar{P}(\Phi' - \sigma_{\Phi'})$.  Below the lower bound value, the score tapers linearly to zero (at a harvest of zero) for under-production.  While finfish aquaculture can create environmental problems, we will not impose a sustainability penalty on overproduction as the impact of BC's finfish aquaculture seems to be very low.

The reference point for each region is the product of this rescaled potential harvest rate and the area of existing aquaculture tenures ($A_f$ and $A_s$ for finfish and shellfish respectively).

$$H_{lowR} = \bar{P}(\Phi' - \sigma_{\Phi'}) * A_{tenure}$$

where $H_{lowR}$ is calculated separately for finfish and shellfish aquaculture classes.

Mariculture score $x_c$ for harvest $H_c$, calculated separately for each aquaculture class $c$:

| value           |           | condition |
|:--------------- |:--------- |:--------- |
| $x_{shellfish} = H/H_{lowR}$ | when | $0 \leq H_{shellfish} < H_{lowR}$ |
| $x_{shellfish} = 1$ | when | $H_{shellfish} \geq H_{lowR}$ |
| $x_{finfish} = H/H_{lowR}$ | when | $0 \leq H_{finfish} < H_{lowR}$ |
| $x_{finfish} = 1$ | when | $H_{finfish} \geq H_{lowR}$ |

The Mariculture score will be the harvest-weighted average of $x_{finfish}$ and $x_{shellfish}$.

$$x_{MAR} = \frac{x_{finfish} * H_{finfish} + x_{shellfish} * H_{shellfish}}{H_{finfish} + H_{shellfish}}$$

-----

# Data sources

* Aquaculture potential data: Gentry/Froehlich 2017
* MaPP Aquaculture SMZs
* DFO Aquaculture tenures

-----

# Methods

## Production potential

### Convert Phi-prime datasets to growth time

* Resample the $\Phi'$ rasters from Gentry/Froehlich 2017 
* Convert $\Phi'$ values to T<sub>b</sub> and T<sub>f</sub> values.
    * Fish: $log(T_F) = 7.68 - 5.82 log(\Phi')$
    * Bivalves: $log(T_B) = 2.99 - 1.66 \Phi'

```{r}
###NOTE: this structure of calculating harvest potential is taken from OHIBC: https://github.com/OHI-Science/ohibc/blob/master/prep/mar/v2017/data_prep_mar.Rmd

####TODO: Non-raster try - fish####
phi_all <- read.csv("CountryProdPotentialLT12.csv")
phif <- phi_all %>%
  select(ID, LABEL, fishphiavg)
tf_mean_df <- phif %>%
  mutate(tf_mean = 7.68 - log(fishphiavg)*5.82)

write.csv(tf_mean_df, "int_gage/tf_mean_df.csv")

phif_max <- read.csv("FishProdByCountryFAOSummaryHDen.csv") %>%
    select(ID, LABEL, MaxPhi) %>%
  inner_join(phi_all) %>%
  mutate(MaxPhi = case_when(
    !is.na(MaxPhi) ~ MaxPhi,
    is.na(MaxPhi) ~ fishphiavg
  )) %>%
  select(ID:MaxPhi) %>%
  mutate(tf_max = 7.68 - log(MaxPhi)*5.82)


```


```{r}
####TODO: Non-raster try - bivalves####

phib <- phi_all %>%
  select(ID, LABEL, bivalvephiavg)

tb_mean_df <- phib %>%
  mutate(tb_mean = exp(2.99 - bivalvephiavg*1.66))

write.csv(tb_mean_df, "int_gage/tb_mean_df.csv")

phib_max <- read.csv("BivalveProdByCountryFAOSummary.csv") %>%
    select(ID, LABEL, MaxPhi) %>%
  inner_join(phi_all) %>%
  mutate(MaxPhi = case_when(
    !is.na(MaxPhi) ~ MaxPhi,
    is.na(MaxPhi) ~ bivalvephiavg
  )) %>%
  select(ID:MaxPhi) %>%
  mutate(tb_max = 7.68 - log(MaxPhi)*5.82)
```


### Calculate production biomass

From the growth time, we calculate biomass production based on the following assumptions and calculations:

* For fish, we assume (from Gentry/Froehlich) a cage stocking density (at harvest) of 11 kg/m^3, 9000 m^3 per cage, and 24 cages per km^2.
    * This results in a harvest per area of 2376 tonnes per km^2.
    * The rate of harvest is 1 harvest every $1/T_F$ years.
    * Harvest intensity = $2376 / T_F$ tonnes per year.
* For bivalves, we assume (from Gentry/Froehlich) 100 long lines per km^2, each of which contains 13,000 feet of fuzzy rope, seeded with 100 bivalves per foot.
    * This results in a harvest per area of 130e6 bivalves (4 cm) per km^2.
    * The rate of harvest is 1 harvest every $1/T_B$ years.
    * Harvest intensity = $130 x 10^6 / T_B$ bivalves per year.
* Lower bounds will be calculated from the $\mu - \sigma$ on $\Phi'$ values.

```{r}
####TODO non raster biomass calcs ####
# Get mean for each of the fish countries
tf_mean_df <- read.csv('int_gage/tf_mean_df.csv')
harvest_fmean_df <- tf_mean_df %>%
  mutate(harvest_fmean = 2376/tf_mean)
write.csv(harvest_fmean_df, "int_gage/harvest_fmean_df.csv")
sum(harvest_fmean_df$harvest_fmean, na.rm = TRUE)
#822528.7 

#
harvest_fmax_df <- phif_max %>%
  mutate(harvest_fmax = 2376/tf_max) 
sum(harvest_fmax_df$harvest_fmax, na.rm = TRUE)
#1125181 but I think from paper should actually be 15 billion (what the paper says for maximum potential finfish aquaculture)?


# Get mean for each of the bivalve countries 
tb_mean_df <- read.csv("int_gage/tb_mean_df.csv")
harvest_bmean_df <- tb_mean_df %>%
  mutate(harvest_bmean = 130e6/tb_mean)
write.csv(harvest_bmean_df, "int_gage/harvest_bmean_df.csv")

sum(harvest_bmean_df$harvest_bmean, na.rm = TRUE)

#=27412919740

harvest_bmax_df <- phib_max %>%
  mutate(harvest_bmax = 130e6/tb_max)
sum(harvest_bmax_df$harvest_bmax, na.rm = TRUE)
#=6174786556 but should be ???
```