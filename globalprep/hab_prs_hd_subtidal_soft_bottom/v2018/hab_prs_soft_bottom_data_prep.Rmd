---
title: "OHI 2018 - Soft bottom pressure data prep"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: show
    toc: true
    toc_depth: 1
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '../../../src/templates/ohi_hdr.html'
pdf_document:
  toc: true
---

[REFERENCE RMD FILE: ADD!!!! after pushing the changes in this file]

# Summary
The habitat pressure data layer is created from catch by gear data of industrial and non industrial fishing profided by Watson (2018). Data is standarized by!!!!!!!!!!!! ADD!!!!!!!

# Updates from previous assessment
[Any significant changes in methods from previous analyses?]
This year we are using the Watson (2018) data to calculate the soft bottom pressure. Data reports catch by gear. 
To each gear we assing a multiplier acording to how much the affect the sea bottom. Here the table with the multipliers (1 is extramly harmfull and 0 is not harmful)

Gear  | Multiplier
------|-----------
Trawl | 1
Dredge | 1
Gillnet | 0.5
Trap  | 0.5
Other | 0.25
Trawl midwater | 0
Pole and Line | 0
Longline | 0
Purse seine | 0
Seine | 0

***

# Data Source 
**Reference**: Watson, R. A. and Tidd, A. 2018. Mapping nearly a century and a half of global marine fishing: 1869â€“2015. Marine Policy, 93, pp. 171-177. [(Paper URL)](https://www.sciencedirect.com/science/article/pii/S0308597X18300605?via%3Dihub)

**Downloaded**: July 17, 2018 from IMAS portal (see prs_fish layer for more details)

**Description**:  Global fisheries landings data per cell separated by Industrial versus Non-Industrial catch, IUU, and discards.

**Native data resolution**: 

**Time range**: 1950 - 2015

**Format**:  csv format

***
  
# Methods !!!!!!!!!!!!!
[R code used to generate the data. Or, alternatively, description of the code/data files used to generate the data.]

***

## Setup

```{r}
library(plyr)
library(tidyverse)
library(parallel)
library(foreach)
library(doParallel)
library(raster)
library(rasterVis)
library(seaaroundus)
library(RColorBrewer)
library(cowplot)
library(stringr)
library(colorspace)
library(sp)
library(rgdal)
library(sf)

#setwd("~/github/ohiprep_v2018/globalprep/hab_prs_hd_subtidal_soft_bottom/v2018")

registerDoParallel(3) # registering cores for parallel processing


source('https://raw.githubusercontent.com/OHI-Science/ohiprep_v2018/master/src/R/spatial_common.R')


## color palette
cols = rev(colorRampPalette(brewer.pal(11, 'Spectral'))(255)) # rainbow color scheme
mytheme=rasterTheme(region=cols)

## Set template ocean raster and mollweide projection CRS
ocean <- raster::raster(file.path(dir_M, 'model/GL-NCEAS-Halpern2008/tmp/ocean.tif'))
mollCRS=crs('+proj=moll +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +units=m +no_defs')

options(scipen=999)


```

## Aggregate annual industrial catch by type of gear

First get the template raster with a resolution of 0.5 degree cells. The `getcells()` function comes from the [seaaroundus R package](https://github.com/ropensci/seaaroundus).

The values of these cells are the Cell ID numbers. In the fisheries catch dataset, these Cell ID numbers match up with the "Seq" numbers.

```{r}

saup_cells <- getcells("POLYGON ((-180 90, 180 90, 180 -90, -180 -90, -180 90))")

saup_rast <- raster(ncol=720, nrow=360)
saup_rast[] <- saup_cells

plot(saup_rast,col=cols,main = "SAUP Cell IDs")

```


Create the rasters for industrial catches

```{r}

years <-  c(2003:2015)

multipliers <- data.frame(FleetGearName = c("Dredge", "Gillnet", "Lines Non-tuna", "Longline Non-tuna", "LonglineTuna", "Other", "Pole and Line Tuna", "Purse seine Non-tuna", "Purse seine Tuna", "Seine", "Trap", "Trawl", "Trawl midwater"), multiplier = c(1, 0.5, 0, 0, 0, 0.25, 0, 0, 0, 0, 0.5, 1, 0))


foreach(yr = years) %dopar%{ #yr = 2015
  
  #read in raw data for the year
  raw_ind <- readRDS(paste0(file.path(dir_M,'git-annex/globalprep/prs_fish/v2018/int/annual_catch/CatchInd_'),yr,'.rds'))
  
  catch_ind <- raw_ind %>%
    dplyr::rowwise() %>%
    dplyr::mutate(catch = sum(Reported, IUU, Discards, na.rm=TRUE)) %>%
    dplyr::left_join(multipliers, by = "FleetGearName") %>% 
    dplyr::mutate(catch_discount = catch*multiplier) %>% 
    dplyr::group_by(Cell) %>%
    dplyr::summarise(cell_catch_ind = sum(catch_discount)) 
  
  
  
  #rasterize catch by swapping cell ids with (calls the suap raster we made above)
  raster::subs(saup_rast, catch_ind, by = 'Cell', which = 'cell_catch_ind', subsWithNA=TRUE, filename = file.path(dir_M, paste0('git-annex/globalprep/hab_prs_hd_subtidal_soft_bottom/v2018/int/disc_ind_catch_',yr,'.tif')), overwrite=TRUE) #saves raster directly to Mazu

}


```


Creat rasters for non industrial catches

```{r}
 

foreach(yr = years) %dopar%{ #yr = 2003
  
  raw_Nind <- readRDS(paste0(file.path(dir_M,'git-annex/globalprep/prs_fish/v2018/int/annual_catch/CatchNInd_'),yr,'.rds'))
  
  catch_Nind <- raw_Nind %>%
    rowwise() %>%
    dplyr::mutate(catch = sum(Reported, IUU, Discards, na.rm=TRUE)) %>%
    left_join(multipliers, by = "FleetGearName") %>% 
    dplyr::mutate(catch_discount = catch*multiplier) %>% 
    dplyr::group_by(Cell) %>%
    dplyr::summarise(cell_catch_Nind = sum(catch_discount))
  
  raster::subs(saup_rast, catch_Nind, by = 'Cell', which = 'cell_catch_Nind', subsWithNA=TRUE, filename = file.path(dir_M, paste0('git-annex/globalprep/hab_prs_hd_subtidal_soft_bottom/v2018/int/disc_Nind_catch_',yr,'.tif')), overwrite=TRUE) #saves raster directly to Mazu
  
}

```

Combining information from industrial and non industrial raster

```{r}

disc_catch_rast_loc <- file.path(dir_M, "git-annex/globalprep/hab_prs_hd_subtidal_soft_bottom/v2018/int")


for(catch_year in 2003:2015){ # catch_year = 2003

  cat(catch_year)

  catch_ind_rast <- raster(file.path(disc_catch_rast_loc, sprintf("disc_ind_catch_%s.tif", catch_year)))
  
  catch_Nind_rast <- raster(file.path(disc_catch_rast_loc, sprintf("disc_Nind_catch_%s.tif", catch_year)))

  catch_count  <- overlay(catch_ind_rast, catch_Nind_rast, fun = function(x,y){x+y}, na.rm= TRUE, progress = 'text',
                           filename = file.path(dir_M,
                          sprintf("git-annex/globalprep/hab_prs_hd_subtidal_soft_bottom/v2018/int/catch_count_%s.tif", catch_year)), overwrite=TRUE)
}


test_total <- raster(file.path(dir_M, "git-annex/globalprep/hab_prs_hd_subtidal_soft_bottom/v2018/int/catch_count_2003.tif"))

plot(test_total)


test_ind <- raster(file.path(dir_M, "git-annex/globalprep/hab_prs_hd_subtidal_soft_bottom/v2018/int/disc_ind_catch_2015.tif"))

plot(test_ind)


test_Nind <- raster(file.path(dir_M, "git-annex/globalprep/hab_prs_hd_subtidal_soft_bottom/v2018/int/disc_Nind_catch_2015.tif"))

plot(test_Nind)


```


Alternative 1 (just create one raster with complete info on industrial and non-industrial)


```{r}
years <-  c(2003:2015)

multipliers <- data.frame(FleetGearName = c("Dredge", "Gillnet", "Lines Non-tuna", "Longline Non-tuna", "LonglineTuna", "Other", "Pole and Line Tuna", "Purse seine Non-tuna", "Purse seine Tuna", "Seine", "Trap", "Trawl", "Trawl midwater"), multiplier = c(1, 0.5, 0, 0, 0, 0.25, 0, 0, 0, 0, 0.5, 1, 0))


foreach(yr = years) %dopar%{ #yr = 2015
  
  #read in raw data for the year
  raw_ind <- readRDS(paste0(file.path(dir_M,'git-annex/globalprep/prs_fish/v2018/int/annual_catch/CatchInd_'),yr,'.rds'))
  
  catch_ind <- raw_ind %>%
    dplyr::rowwise() %>%
    dplyr::mutate(catch = sum(Reported, IUU, Discards, na.rm=TRUE)) %>%
    dplyr::left_join(multipliers, by = "FleetGearName") %>% 
    dplyr::mutate(catch_discount = catch*multiplier) %>% 
    dplyr::group_by(Cell) %>%
    dplyr::summarise(cell_catch_ind = sum(catch_discount)) 
  
  raw_Nind <- readRDS(paste0(file.path(dir_M,'git-annex/globalprep/prs_fish/v2018/int/annual_catch/CatchNInd_'),yr,'.rds'))
  
  catch_Nind <- raw_Nind %>%
    rowwise() %>%
    dplyr::mutate(catch = sum(Reported, IUU, Discards, na.rm=TRUE)) %>%
    left_join(multipliers, by = "FleetGearName") %>% 
    dplyr::mutate(catch_discount = catch*multiplier) %>% 
    dplyr::group_by(Cell) %>%
    dplyr::summarise(cell_catch_Nind = sum(catch_discount))
  
  catch_total <- catch_ind %>% 
    dplyr::full_join(catch_Nind, by= "Cell") %>% 
    dplyr::mutate(total = cell_catch_ind + cell_catch_Nind) %>% 
    dplyr::mutate(total = ifelse(is.na(total), cell_catch_ind, total)) %>% 
    dplyr::select(Cell, total)
  
  
  catch_total <- catch_ind %>% 
    dplyr::full_join(catch_Nind, by= "Cell") %>%
    dplyr::rowwise() %>% 
    dplyr::mutate(total = sum(cell_catch_ind, cell_catch_Nind, na.rm = TRUE)) %>%
    dplyr::select(Cell, total)
     
  
  #rasterize catch by swapping cell ids with (calls the suap raster we made above)
  raster::subs(saup_rast, catch_total, by = 'Cell', which = 'total', subsWithNA=TRUE, filename = file.path(dir_M, paste0('git-annex/globalprep/hab_prs_hd_subtidal_soft_bottom/v2018/int/catch_count_',yr,'.tif')), overwrite=TRUE) #saves raster directly to Mazu
  
}

test_test <- raster(file.path(dir_M, ('git-annex/globalprep/hab_prs_hd_subtidal_soft_bottom/v2018/int/catch_count_2015.tif')))

plot(test_test)



```





