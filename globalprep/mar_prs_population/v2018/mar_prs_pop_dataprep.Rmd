---
title: 'OHI 2018: Mariculture Population Pressure Layers'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: show
    toc: true
    toc_depth: 1
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '../../../src/templates/ohi_hdr.html'
pdf_document:
  toc: true
---

[REFERENCE RMD FILE](https://cdn.rawgit.com/OHI-Science/ohiprep/master/globalprep/mar/v2018/mar_prs_pop_dataprep.html)


# Summary

This document describes the steps for obtaining and wrangling the data used to calculate the mariculture population pressure subdimension for the 2018 global assessment.

The general data preparation calculations are summarized [here](http://ohi-science.org/ohi-global/layers.html#inland_coastal_population). For context and explanation see the mariculture (subgoal of food provision) [model summary](http://ohi-science.org/ohi-global/goals.html#food_provision:_mariculture).

# Updates from previous assessment
No updates were made to this methodology since the previous assessment.

***

# Data Sources

## CIESE and CIAT Gridded Population of the World (v4)

**Reference**: http://sedac.ciesin.columbia.edu/data/collection/gpw-v4

**Downloaded**: June 3 2016

**Description**:
Population counts and population density. Population estimates for 2000, 2005, 2010, 2015, 2020, extrapolated from results of the 2010 Population and Housing Censuses which occurred between 2005 and 2014. Estimates adjusted to national level, historic and future, population predictions from the United Nation's World Population Prospects report are also included in the dataset. Documentation for gridded population of the world is located [here](http://sedac.ciesin.columbia.edu/downloads/docs/gpw-v4/gpw-v4-documentation.pdf).

**Native data resolution**: 30 arc-seconds

**Time range**: 2000-2020

**Format**: GeoTiff

## UN Population

UN population data is used in this data prep routine to check population counts; spatially distributed counts derived from the gridded world population are aggregated by region and checked against the UN population estimates.

**Reference**: https://esa.un.org/unpd/wpp/

**Downloaded**: August 24 2017

**Description**: Population (in thousands) for countries.

**Native data resolution**: Country scores

**Time range**: 1950-2015

**Format**: Excel file

***

# Setup

Load all relevant libraries including parallel processing packages, and define frequently used pathnames. Change scenario and data years in file pathnames code chunk to reflect most recent data (d) and current assessment year (v).

```{r setup, message=FALSE, warning=FALSE, verbose=FALSE}
## set options for all chunks in code
knitr::opts_chunk$set(warning=FALSE, message=FALSE, fig.width = 6, fig.height = 4, fig.path = 'figs/')

## comment out when knitting
# setwd("globalprep/mar_prs_population/v2018")
```

```{r file paths}
source("../../../src/R/common.R")
source("../../../src/R/spatial_common.R")

scenario_yr <- "v2018" # change to reflect assessment year!
data_yr_gpw <- "d2017" # change to reflect year of most recently downloaded data!
data_yr_un_pop <- "d2017" # change to reflect year of most recently downloaded data!

## define commonly used file paths
path_raw_data <- file.path(dir_M, "git-annex/globalprep/_raw_data")
path_mar_prs <- file.path(dir_M, "git-annex/globalprep/mar_prs_population", scenario_yr)
```

```{r packages}
## load packages, installing them first where necessary
if(!requireNamespace("raster", quietly = TRUE))
  install.packages("raster")
if(!requireNamespace("ohicore", quietly = TRUE))
  devtools::install_github("ohi-science/ohicore")
if(!requireNamespace("dplyr", quietly = TRUE))
  install.packages("tidyverse")
if(!requireNamespace("sf", quietly = TRUE))
  install.packages("sf")
if(!requireNamespace("fasterize", quietly = TRUE))
  install.packages("fasterize")
if(!requireNamespace("foreach", quietly = TRUE))
  install.packages("foreach")

library(ohicore)

## spatial libraries
library(raster)
library(rgdal)
library(sp)
library(sf)
library(fasterize)

## wrangling libraries
library(dplyr)
library(stringr)

## parallel processing libraries
library(parallel)
library(foreach)
library(doParallel)
```

# Methods and Calculations

## Import Raw Data

Raw datasets used in this data prep include: raw CIESE/CIAT population, UN population, ocean raster, and eez raster. Standardized eez_raster and ocean rasters for the OHI are sourced from src/spatial_commons.R, as "zones" and "ocean" repectively.

```{r import raw data}
## eez raster used in creating 25 mile inland raster, sourced as "zones" from src/spatial_commons.R
eez_raster <- zones;

## read in the raw density data to be reprojected and resampled
raw <- list.files(file.path(path_raw_data, sprintf("CIESEandCIAT_population/%s", data_yr_gpw)), 
                  full.names = TRUE, pattern = "\\.tif$",
                  recursive = TRUE)
raw <- raw[grep("density", raw)]

## import raw, cleaned UN population data to be wrangled then used to confirm gpw-derived spatial population
pop <- read.csv(file.path(path_raw_data, sprintf("UnitedNations_population/%s/UN_pop_clean.csv", data_yr_un_pop)),
        strip.white = TRUE, stringsAsFactors = FALSE)

```

## Project, Resample, Interpolate

Gridded world population densities from CIESE and CIAT are projected into the World Mollweide coordinate reference system and resampled using nearest neighbor method to match the ocean raster (934.4789 x 934.4789 meter resolution); missing years must be filled by interpolation.

```{r manipulate spatial data}
## convert year to numeric, project raster, resample, and save human_density_year_mol.tif with these updates
for(rast in raw){
  yr <- as.numeric(as.character(str_sub(rast, -8, -5))) # eigth-to-last thru fifth-to-last characters of filename give year
  raster(rast) %>%
    projectRaster(crs = crs(ocean), over=TRUE) %>%
    resample(ocean, method = 'ngb',
             filename = file.path(path_mar_prs, sprintf("int/human_density_%s_mol.tif", yr)),
             overwrite = TRUE)
}
```

```{r functions for interpolation}

## function to calculate yearly change in population density
files <- list.files(file.path(path_mar_prs, "int"), pattern = "_mol.tif", full = TRUE)

yearly_diff <- function(year_min, year_max, density_files = files){
  rast_diff <- stack(density_files[grep(year_max, density_files)], density_files[grep(year_min, density_files)]) %>%
    overlay(fun = function(x, y){(x - y)/5},
            filename = file.path(path_mar_prs, sprintf("yearly_change_%s_to_%s.tif", year_min, year_max)),
            overwrite = TRUE)
}

yearly_diff(year_min = 2000, year_max = 2005)
yearly_diff(year_min = 2005, year_max = 2010)
yearly_diff(year_min = 2010, year_max = 2015)
yearly_diff(year_min = 2015, year_max = 2020)

## function to interpolate population densities between years
yearly_interpolate <- function(year, start_raster, yearly_change){
  stack(start_raster, yearly_change) %>%
    for(i in 1:4){
      overlay(fun = function(x, y){(x + i*y)},
              filename = file.path(path_mar_prs, sprintf("int/human_density_%s_mol.tif", (year+i))),
              overwrite = TRUE)
    }
}

## interpolate missing years
files <- list.files(file.path(path_mar_prs, "int"), pattern = ".tif", full = TRUE)

yearly_interpolate(2000, start_raster = files[grep("2000_mol", files)], yearly_change = files[grep("2000_to_2005", files)])
yearly_interpolate(2005, start_raster = files[grep("2005_mol", files)], yearly_change = files[grep("2005_to_2010", files)])
yearly_interpolate(2010, start_raster = files[grep("2010_mol", files)], yearly_change = files[grep("2010_to_2015", files)])
yearly_interpolate(2015, start_raster = files[grep("2015_mol", files)], yearly_change = files[grep("2015_to_2020", files)])

```

## Convert Density to Population 

Density data are converted to population by multiplying density times the area of the cell (934.4789x934.4789) and converting to square km from square meters, to get people per square km. GWPv4 provides both densities and population counts, but, we derive population counts from density because **(?)**

```{r convert density data to population count}

den_raster <- list.files(file.path(path_mar_prs, "int"), pattern = "\\_mol.tif$", full = TRUE)
den_raster # check to make sure this looks correct; all and only density tifs in folder

for(rast in den_raster){
  nm <- basename(rast)
  yr <- str_sub(nm, -12, -9)
  cat(nm)
  tmp <- raster(rast)
  calc(tmp, fun = function(x){x * (934.4789 * 934.4789 * 0.000001)},
       filename = file.path(path_mar_prs, sprintf("int/human_count_%s_mol.tif", yr)),
       overwrite=TRUE)
}
```

## Create EEZ plus 25-mile Inland Raster

```{r create eez + 25-mile inland raster}
## re-add in Fiji which appears to get cut: include all of Fiji land falling within 50 mile boundary
fiji <- regions %>%
  filter(rgn_type == "land" & rgn_id==18) %>%
  select(rgn_id, geometry)

## create the 25-mile inland raster and add Fiji
inland <- sf::read_sf(dsn = file.path(dir_M, "git-annex/Global/NCEAS-Regions_v2014/data"), 
                      layer = "sp_inland25mi_gcs") %>%
  select(rgn_id, geometry)

inland <- st_transform(inland, st_crs(fiji))
inland <- rbind(inland, fiji)

## save shapefile for future reference if it doesn't already exist
if (!file.exists(file.path(dir_M, "git-annex/globalprep/spatial/v2017/EEZ_inland_50mi"))){
  st_write(inland, dsn = file.path(dir_M, "git-annex/globalprep/spatial/v2017/EEZ_inland_50mi"), 
           layer = "EEZ_inland_50mi", driver="ESRI Shapefile")
}

inland_raster <- fasterize::fasterize(inland, eez_raster, field = 'rgn_id')

## make sure all regions are included with reasonable area (number of cells) for each
tmp <- raster::freq(inland_raster) 
tmp2 <- data.frame(tmp) %>%
  dplyr::arrange(value)

## merge 
raster::merge(eez_raster, inland_raster, filename = file.path(path_mar_prs, "int/eez_25mi_inland.tif"))

```

## Create UN_population.csv for data checking later

```{r create un_population.csv}
pop_gather <- pop %>%
  gather("year", "population", starts_with("X")) %>%
  mutate(population = gsub(" ", "", population)) %>%
  mutate(year = gsub("X", "", year)) %>%
  mutate(population = as.numeric(as.character(population)) * 1000)

## Channel Islands: ignore Jersey and Guernsey for now
pop_gather_rename <- pop_gather %>%
  mutate(country = ifelse(str_detect(country,"C\\Ste d'Ivoire"), "Cote d'Ivoire", country)) %>%
  mutate(country = ifelse(str_detect(country,"R\\Sunion"), "Reunion", country)) %>%
  mutate(country = ifelse(str_detect(country,"Cura\\Sao"), "Curacao", country)) %>%
  mutate(country = ifelse(country=="China, Taiwan Province of China", "Taiwan", country)) %>%
  mutate(country = ifelse(country=="Dem. People's Republic of Korea", "North Korea", country))
  
## organize the data by regions used in OHI
pop_rgn <- name_2_rgn(df_in = pop_gather_rename, 
                      fld_name='country', 
                      flds_unique=c('year'))
pop_rgn <- pop_rgn %>%
  group_by(rgn_id, year) %>%
  summarize(population = sum(population)) %>%
  data.frame()

## save wrangled UN population data  
write.csv(pop_rgn, "globalprep/mar_prs_population/v2017/output/UN_population.csv", row.names=FALSE)

```

# Tidy/Wrangle

## Extract by or Add OHI Regions

```{r extract population data from all population layers}

zones <- raster(file.path(dir_M, "git-annex/globalprep/mar_prs_population/v2017/int/eez_25mi_inland.tif"))
pop_rasts <- list.files(file.path(dir_M, "git-annex/globalprep/mar_prs_population/v2017/int"), 
           pattern = "mol.", full=TRUE)
pop_stack <- raster::stack(pop_rasts)
coastal_pop <- raster::zonal(pop_stack, zones, fun="sum", progress="text")

write.csv(coastal_pop, "globalprep/mar_prs_population/v2017/int", row.names=FALSE)

coastal_pop2 <- data.frame(coastal_pop) %>%
  tidyr::gather("year", "coastal_pop_25mi", -1) %>%
  dplyr::select(rgn_id=zone, year=year, popsum=coastal_pop_25mi) %>%
  dplyr::mutate(year = as.numeric(as.character(substring(year, 13, 16)))) %>%
  dplyr::filter(rgn_id <= 250)

write.csv(coastal_pop2, "globalprep/mar_prs_population/v2017/output/mar_pop_25mi.csv", row.names = FALSE)

```

# Gapfilling

No gapfilling was completed as part of this data prep methodology. Datasets are saved with "_gf" appended just to indicate they are finalized versions.

```{r save prs_pop_density and mar_pop_25mi layers}

prs <- read.csv("globalprep/mar_prs_population/v2017/output/prs_pop_density.csv") %>%
  mutate(pressure_score = 0)
mar <- read.csv("globalprep/mar_prs_population/v2017/output/mar_pop_25mi.csv") %>%
  mutate(popsum = 0)

write.csv(prs, "globalprep/mar_prs_population/v2017/output/prs_pop_density_gf.csv", row.names = FALSE)
write.csv(mar, "globalprep/mar_prs_population/v2017/output/mar_pop_25mi_gf.csv", row.names = FALSE)

```

# Data Checks and/or Meta-analysis

```{r check full calculated population against latest UN population data}

pop_rast <- raster(file.path(dir_M, 
          "git-annex/globalprep/mar_prs_population/v2017/int/human_count_2015_mol.tif")) # update year in filename accordingly
zones <- raster(file.path(dir_M,"git-annex/globalprep/spatial/v2017/regions_land_ocean.tif"))
pop_counts <- zonal(pop_rast, zones, fun = "sum", na.rm=TRUE)

pop_UN <- read.csv("globalprep/mar_prs_population/v2017/output/UN_population.csv") %>%
  dplyr::filter(year==2015) %>%
  dplyr::select(rgn_id, pop_UN=population)

compare_pop <- data.frame(pop_counts) %>%
  dplyr::select(rgn_id = zone, pop_rast = sum) %>%
  dplyr::left_join(pop_UN, by="rgn_id")

plot(log(compare_pop$pop_rast), log(compare_pop$pop_UN))
abline(0,1, col="red")

```

```{r quick comparison with previous year's data}

old <- read.csv("globalprep/mar_prs_population/v2016/output/mar_pop_25mi.csv") %>%
  dplyr::select(rgn_id, year, popsum_old=popsum)

tmp <- coastal_pop2 %>%
  dplyr::left_join(old, by=c("rgn_id", "year"))

plot(log(tmp$popsum), log(tmp$popsum_old))
abline(0,1, col="red")
```


***

